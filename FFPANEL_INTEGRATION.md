# Руководство по интеграции с FFPanel

## Обзор
Интеграция с FFPanel позволяет автоматически синхронизировать домены между Reverse Proxy Control Center и FFPanel. Это упрощает управление доменами и обеспечивает согласованность настроек между двумя системами.

## Требования
- Токен API FFPanel (доступен в настройках вашего аккаунта FFPanel)
- Домен, который вы хотите синхронизировать
- Административный доступ к Reverse Proxy Control Center

## Настройка интеграции

### 1. Установка токена FFPanel

#### Через веб-интерфейс:
1. Войдите в систему с правами администратора
2. Перейдите в раздел "Настройки системы"
3. Найдите поле "Токен API FFPanel"
4. Введите ваш токен FFPanel
5. Нажмите "Сохранить настройки"

#### Через переменную окружения:
Вы также можете установить токен FFPanel через переменную окружения:
```bash
export FFPANEL_TOKEN="ваш_токен_ffpanel"
```

После перезапуска приложения переменная окружения будет автоматически использоваться, если токен не указан в настройках системы.

#### Проверка токена:
Чтобы проверить, что токен установлен корректно, можно использовать диагностический скрипт:
```bash
python debug_ffpanel_integration.py
```

### 2. Включение FFPanel для домена

#### Через веб-интерфейс:
1. Перейдите в раздел "Домены"
2. Выберите домен, который хотите синхронизировать
3. Перейдите на вкладку "Редактировать"
4. Установите флажок "Включить интеграцию с FFPanel"
5. Выберите источник IP-адреса для FFPanel:
   - Тот же IP, что и у домена
   - IP выбранного сервера (выберите из выпадающего списка)
   - IP выбранного внешнего сервера (выберите из выпадающего списка)
   - Указать IP-адрес вручную
6. Нажмите "Сохранить"

#### Через скрипт обновления:
Также можно включить FFPanel для одного или нескольких доменов с помощью скрипта:
```bash
python domain_ffpanel_check.py <domain_id>
```

### 3. Синхронизация домена с FFPanel

#### Через веб-интерфейс:
1. На странице домена перейдите на вкладку "FFPanel"
2. Проверьте параметры синхронизации (порты, DNS)
3. Нажмите кнопку "Создать в FFPanel" или "Обновить в FFPanel"

#### Массовая синхронизация:
Для импорта всех доменов из FFPanel в систему:
1. Перейдите в раздел "Домены"
2. Выберите "Импорт из FFPanel"
3. Нажмите "Импортировать"

## Статусы синхронизации

- **Синхронизирован**: Домен успешно синхронизирован с FFPanel
- **Ошибка синхронизации**: Произошла ошибка при синхронизации
- **Не синхронизирован**: Домен еще не был синхронизирован с FFPanel

## Устранение неполадок

### Токен не распознается
1. Убедитесь, что токен введен правильно без лишних пробелов
2. Проверьте, что токен активен в вашем аккаунте FFPanel
3. Попробуйте запустить диагностический скрипт:
   ```bash
   python debug_ffpanel_integration.py
   ```

### Ошибка синхронизации
1. Проверьте, что домен имеет корректные параметры (имя, IP-адрес, порты)
2. Убедитесь, что домен не был удален из FFPanel вручную
3. Проверьте сообщение об ошибке в журнале приложения

### Домен виден в FFPanel, но не в Reverse Proxy Control Center
Выполните импорт доменов из FFPanel:
1. Перейдите в раздел "Домены"
2. Выберите "Импорт из FFPanel"
3. Нажмите "Импортировать"

## Дополнительные скрипты

### debug_ffpanel_integration.py
Диагностический скрипт для проверки подключения к FFPanel API:
```bash
python debug_ffpanel_integration.py
```

### domain_ffpanel_check.py
Скрипт для проверки и активации интеграции FFPanel для конкретного домена:
```bash
python domain_ffpanel_check.py <domain_id>
```

### update_ffpanel_token.py
Скрипт для обновления токена FFPanel из переменной окружения:
```bash
python update_ffpanel_token.py
```

### test_ffpanel_api.py
Скрипт для тестирования работы API FFPanel вне контекста Flask:
```bash
python test_ffpanel_api.py
```

## Примечания
- При удалении домена из Reverse Proxy Control Center он не удаляется автоматически из FFPanel
- Для удаления домена из FFPanel используйте вкладку "FFPanel" на странице домена
- Изменения в FFPanel могут появиться не сразу из-за кэширования
- Класс FFPanelAPI может работать как внутри контекста Flask, так и вне его благодаря универсальной системе логирования
- В выпадающем списке выбора IP-адреса для FFPanel отображаются все доступные серверы и внешние серверы
- При выборе опции "Тот же IP, что и у домена" значение будет автоматически синхронизироваться при изменении основного IP

## Поддержка
При возникновении проблем с интеграцией, обратитесь к администратору системы или проверьте журналы приложения для получения дополнительной информации.