{% extends 'layout.html' %}

{% block title %}{{ server.name }} - Внешний сервер{% endblock %}

{% block extra_head %}
<!-- Подключаем Chart.js для графиков -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('external_servers.index') }}">Внешние серверы</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ server.name }}</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>
                        {{ server.name }}
                        <span class="badge {% if server.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if server.is_active %}Активен{% else %}Неактивен{% endif %}
                        </span>
                    </h1>
                    <p class="text-muted">
                        <i class="fas fa-network-wired me-1"></i> {{ server.ip_address }}
                        {% if server.location %} | <i class="fas fa-map-marker-alt me-1"></i> {{ server.location }}{% endif %}
                    </p>
                </div>
                <div class="btn-group">
                    <a href="{{ server.get_glances_web_url() }}" target="_blank" class="btn btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> Открыть Glances
                    </a>
                    <a href="{{ url_for('external_servers.edit', server_id=server.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-edit"></i> Редактировать
                    </a>
                    <form action="{{ url_for('external_servers.check', server_id=server.id) }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-info">
                            <i class="fas fa-sync-alt"></i> Обновить метрики
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Информация о сервере</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <h6 class="card-subtitle text-muted">Статус</h6>
                        {% if server.last_status == 'ok' %}
                            <span class="badge bg-success">В порядке</span>
                        {% elif server.last_status == 'warning' %}
                            <span class="badge bg-warning text-dark">Предупреждение</span>
                        {% elif server.last_status == 'error' %}
                            <span class="badge bg-danger">Ошибка</span>
                        {% else %}
                            <span class="badge bg-secondary">Неизвестно</span>
                        {% endif %}
                    </div>

                    <div class="mb-2">
                        <h6 class="card-subtitle text-muted">IP-адрес</h6>
                        <p>{{ server.ip_address }}</p>
                    </div>

                    {% if server.location %}
                    <div class="mb-2">
                        <h6 class="card-subtitle text-muted">Местоположение</h6>
                        <p>{{ server.location }}</p>
                    </div>
                    {% endif %}

                    <div class="mb-2">
                        <h6 class="card-subtitle text-muted">Порт Glances</h6>
                        <p>{{ server.glances_port }}</p>
                    </div>

                    <div class="mb-2">
                        <h6 class="card-subtitle text-muted">Аутентификация Glances</h6>
                        <p>{% if server.glances_api_user %}Настроена{% else %}Не настроена{% endif %}</p>
                    </div>

                    <div class="mb-2">
                        <h6 class="card-subtitle text-muted">Последняя проверка</h6>
                        <p>
                            {% if server.last_check_time %}
                                {{ server.last_check_time|humanize_timestamp }}
                            {% else %}
                                Никогда
                            {% endif %}
                        </p>
                    </div>

                    {% if server.description %}
                    <div class="mb-2">
                        <h6 class="card-subtitle text-muted">Описание</h6>
                        <p>{{ server.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Текущие метрики</h5>
                        <span class="badge bg-light text-dark">
                            {% if server.last_check_time %}
                                Обновлено {{ server.last_check_time|humanize_timestamp }}
                            {% else %}
                                Нет данных
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    {% if server.cpu_percent is not none or server.memory_percent is not none or server.disk_percent is not none %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="metric-card text-center mb-3">
                                    <h6>Загрузка CPU</h6>
                                    <div class="d-flex justify-content-center">
                                        <div class="progress-circle 
                                            {% if server.cpu_percent > 80 %}bg-danger{% elif server.cpu_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                            style="width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <div class="progress-circle-inner" style="width: 100px; height: 100px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center;">
                                                <h3 class="mb-0">{{ server.cpu_percent|round(1) }}%</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="metric-card text-center mb-3">
                                    <h6>Использование памяти</h6>
                                    <div class="d-flex justify-content-center">
                                        <div class="progress-circle 
                                            {% if server.memory_percent > 80 %}bg-danger{% elif server.memory_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                            style="width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <div class="progress-circle-inner" style="width: 100px; height: 100px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center;">
                                                <h3 class="mb-0">{{ server.memory_percent|round(1) }}%</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="metric-card text-center mb-3">
                                    <h6>Использование диска</h6>
                                    <div class="d-flex justify-content-center">
                                        <div class="progress-circle 
                                            {% if server.disk_percent > 80 %}bg-danger{% elif server.disk_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                            style="width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <div class="progress-circle-inner" style="width: 100px; height: 100px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center;">
                                                <h3 class="mb-0">{{ server.disk_percent|round(1) }}%</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if server.load_avg_1 is not none or server.load_avg_5 is not none or server.load_avg_15 is not none %}
                        <div class="mt-3">
                            <h6>Load Average</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5 class="mb-0">{{ server.load_avg_1 }}</h5>
                                            <p class="text-muted mb-0">1 min</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5 class="mb-0">{{ server.load_avg_5 }}</h5>
                                            <p class="text-muted mb-0">5 min</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h5 class="mb-0">{{ server.load_avg_15 }}</h5>
                                            <p class="text-muted mb-0">15 min</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Нет данных о метриках. Нажмите "Обновить метрики", чтобы получить текущие данные с сервера.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="metrics-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="cpu-tab" data-bs-toggle="tab" data-bs-target="#cpu" type="button" role="tab" aria-controls="cpu" aria-selected="true">CPU</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory" type="button" role="tab" aria-controls="memory" aria-selected="false">Память</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="disk-tab" data-bs-toggle="tab" data-bs-target="#disk" type="button" role="tab" aria-controls="disk" aria-selected="false">Диск</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="load-tab" data-bs-toggle="tab" data-bs-target="#load" type="button" role="tab" aria-controls="load" aria-selected="false">Load Average</button>
                        </li>
                        <li class="nav-item ms-auto">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadChartData('24h')">24 часа</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadChartData('7d')">7 дней</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadChartData('30d')">30 дней</button>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="metrics-tab-content">
                        <div class="tab-pane fade show active" id="cpu" role="tabpanel" aria-labelledby="cpu-tab">
                            <canvas id="cpu-chart" height="300"></canvas>
                        </div>
                        <div class="tab-pane fade" id="memory" role="tabpanel" aria-labelledby="memory-tab">
                            <canvas id="memory-chart" height="300"></canvas>
                        </div>
                        <div class="tab-pane fade" id="disk" role="tabpanel" aria-labelledby="disk-tab">
                            <canvas id="disk-chart" height="300"></canvas>
                        </div>
                        <div class="tab-pane fade" id="load" role="tabpanel" aria-labelledby="load-tab">
                            <canvas id="load-chart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">История метрик</h5>
                        <span class="text-muted">Последние 100 замеров</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Время</th>
                                <th>CPU</th>
                                <th>Память</th>
                                <th>Диск</th>
                                <th>Load Avg (1m)</th>
                                <th>Load Avg (5m)</th>
                                <th>Load Avg (15m)</th>
                                <th>Процессы</th>
                                <th>Сеть (IN/OUT)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for metric in metrics %}
                                <tr>
                                    <td>{{ metric.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="height: 6px; width: 50px;">
                                                <div class="progress-bar {% if metric.cpu_percent > 80 %}bg-danger{% elif metric.cpu_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                     style="width: {{ metric.cpu_percent }}%;"></div>
                                            </div>
                                            {{ metric.cpu_percent|round(1) }}%
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="height: 6px; width: 50px;">
                                                <div class="progress-bar {% if metric.memory_percent > 80 %}bg-danger{% elif metric.memory_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                     style="width: {{ metric.memory_percent }}%;"></div>
                                            </div>
                                            {{ metric.memory_percent|round(1) }}%
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="height: 6px; width: 50px;">
                                                <div class="progress-bar {% if metric.disk_percent > 80 %}bg-danger{% elif metric.disk_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                     style="width: {{ metric.disk_percent }}%;"></div>
                                            </div>
                                            {{ metric.disk_percent|round(1) }}%
                                        </div>
                                    </td>
                                    <td>{{ metric.load_avg_1|round(2) }}</td>
                                    <td>{{ metric.load_avg_5|round(2) }}</td>
                                    <td>{{ metric.load_avg_15|round(2) }}</td>
                                    <td>{{ metric.processes_total }} ({{ metric.processes_running }} активных)</td>
                                    <td>{{ (metric.network_in_bytes / 1024 / 1024)|round(2) }} MB / {{ (metric.network_out_bytes / 1024 / 1024)|round(2) }} MB</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cpuChart, memoryChart, diskChart, loadChart;
let currentPeriod = '24h';

// Инициализация графиков при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadChartData(currentPeriod);
});

function loadChartData(period) {
    currentPeriod = period;
    fetch('{{ url_for("external_servers.get_metrics_json", server_id=server.id) }}?period=' + period)
        .then(response => response.json())
        .then(data => {
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
}

function updateCharts(data) {
    // Определяем общие настройки
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            x: {
                ticks: {
                    maxTicksLimit: 10
                }
            },
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    };

    // CPU Chart
    const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
    if (cpuChart) cpuChart.destroy();
    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
            labels: data.timestamps,
            datasets: [{
                label: 'CPU (%)',
                data: data.cpu,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: chartOptions
    });

    // Memory Chart
    const memoryCtx = document.getElementById('memory-chart').getContext('2d');
    if (memoryChart) memoryChart.destroy();
    memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: {
            labels: data.timestamps,
            datasets: [{
                label: 'Память (%)',
                data: data.memory,
                borderColor: 'rgb(153, 102, 255)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                tension: 0.1
            }]
        },
        options: chartOptions
    });

    // Disk Chart
    const diskCtx = document.getElementById('disk-chart').getContext('2d');
    if (diskChart) diskChart.destroy();
    diskChart = new Chart(diskCtx, {
        type: 'line',
        data: {
            labels: data.timestamps,
            datasets: [{
                label: 'Диск (%)',
                data: data.disk,
                borderColor: 'rgb(255, 159, 64)',
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                tension: 0.1
            }]
        },
        options: chartOptions
    });

    // Load Chart
    const loadCtx = document.getElementById('load-chart').getContext('2d');
    if (loadChart) loadChart.destroy();
    loadChart = new Chart(loadCtx, {
        type: 'line',
        data: {
            labels: data.timestamps,
            datasets: [
                {
                    label: '1 min',
                    data: data.load_avg_1,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                },
                {
                    label: '5 min',
                    data: data.load_avg_5,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1
                },
                {
                    label: '15 min',
                    data: data.load_avg_15,
                    borderColor: 'rgb(255, 205, 86)',
                    backgroundColor: 'rgba(255, 205, 86, 0.2)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: 10
                    }
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}
</script>
{% endblock %}